---
title: 早期(编译器)优化
date: 2021-12-05 18:55:06
permalink: /pages/c689bf/
categories:
  - JVM虚拟机专栏
  - 深入理解JVM
tags:
  - 
---
### 概述

Java 语言的编译器是一段不确定的操作过程，因为它可能是一个把 Java 文件编译成为 class 文件的过程；也可能是指虚拟机的后段运行期编译器（JIT 编译器）把自己饿吗转变成机器码的过程；还有可能是使用静态提前编译器（AOT 编译器）直接把 Java 文件编译为机器码的过程。

1. 前段编译器： javac、Eclipse JDT 中的增量式编译器 （ECJ）
2. JIT 编译器：HotSport VM 的 C1、C2编译器
3. AOT 编译器： GNU     complier for Java （GCJ）、Excelsior JET

### Javac 编译器

使用 Java 编写的程序

Javac 的源码与调试：源码放在     JDK_SRC_HOME/langtools/src/share/com/sun/tools/javac 中

Javac 的代码来看，编译过程大致可分为 3 个过程：

1. 解析与填充符号表过程
2. 插入式注解处理器的注解处理过程
3. 分析与字节码生成过程

##### 解析与填充符号表

1. 词法、语法分析
   - 词法分析是将源代码的字符流转变为标记（Token）集合，单个字符是程序编写过程的最小单位，而标记则是编译器过程的最小元素，关键字、变量名、字面量、运算符都可以成为标记
   - 语法分析是根据 Token 序列构造抽象语法树的过程，抽象语法树（Abstract Syntax Tree，AST）是一种用来描述程序代码语法结构的树形表达方式，语法树的每一个节点都代表着程序代码中的一个语法结构，如 包、类型、修饰符、运算符、接口、返回值甚至代码注释等都可以是一个语法结构。
2. 填充符号表
   - 语法分析的下一步就是填充符号表的过程，符号表是由一组符号地址和符号信息构成的表格，在目标代码生成阶段，当对符号名进行地址分配时，符号表是地址分配的依据。

##### 注解处理器

1. JDK1.5 之后，Java语言提供了对注解的支持，这些注解与普通的Java 代码一样，是在运行期间发挥作用的。
2. JDK1.6 中实现了     JSR-269规范，提供了一组插入式注解处理器的标准 API 在编译期间对注解进行处理。
3. 在处理注解期间对语法树进行了修改，编译器将回到解析及填充符号表的过程重新处理，直到所有插入式注解处理器都没有在对语法树进行修改为止。
4. 有了编译器注解处理器的标准 API 后，我们的代码才有可能干涉编译器的行为。

##### 语义分析和字节码生成

语法分析之后，编译器获得了程序代码的抽象语法树表示，语法树表示一个结构正确的源程序的抽象，但无法保证源程序是符合逻辑的。而语义分析的主要任务就是对结构正确的源程序进行上下文有关性质的审查，如进行类型审查。

1. 标注检查：标注检查的内容

2. 1. 变量使用前是否已经被声明
   2. 变量与赋值之间的数据类型是否能够匹配等。
   3. 常量折叠

3. 数据及控制流分析：是对程序上下文逻辑更近一步的验证，它可以检查出如程序局部变量在使用之前是否有被赋值、方法的每条路径是否都有返回值、是否所有的受查异常都被正确处理了等问题。

4. 1. 将局部变量声明为final ，对运行期是没有影响的，变量的不变性仅仅有编译器在编译期间保证。

5. 解语法糖：

6. 1. 泛型、变长参数（数组）、自动拆箱（Integer.valueOf() 函数）/自动装箱等
   2. 虚拟机不支持这些语法，他们在编译阶段被还原成最简单的语法结构。

7. 字节码生成：

8. 1. 前面各个步骤生成的信息转化成字节码写到磁盘中
   2. 编译器还进行了少量代码的添加和转换工作。如实例构造器      \<init>方法和类构造器 \<clinit> 方法就是在这个阶段添加到语法树中的。
   3. 还有代码替换工作，如使用连接符 ‘+’      链接的字符串使用StringBuilder 代替。

### Java 语法糖的味道

##### 泛型与类型擦除

1. 本质是参数化类型的应用
2. C# 和 Java     对泛型技术支持的区别 List<int> 和 List<String> 在C# 中就是两个不同的类型，称为真泛型；
3. Java     语言中的泛型则不一样，它只在程序源码中存在，在编译后的字节码文件中，就已经替换为原来的原生类型了，并且在相应的地方插入了强制转型代码，Java     语言中的泛型实现方法称为类型擦除，基于这种方法实现的泛型称为伪泛型。
4. Signature、LocalVariableTypetable     等新的属性用于解决伴随泛型而来的参数类型的识别问题。

##### 自动装箱、拆箱与便利循环

##### 条件编译：使用条件为常量的 if 语句。